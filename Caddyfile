:80 {
	log

	handle /health {
		respond "OK" 200
	}

	handle {
		# Match /user/repo pattern → instll/install.sh
		@install_script path_regexp user_repo ^/([^/]+)/([^/]+)/?$
		header @install_script Cache-Control "no-cache, no-store, must-revalidate"
		header @install_script Pragma "no-cache"
		header @install_script Expires "0"
		redir @install_script https://raw.githubusercontent.com/{re.user_repo.1}/{re.user_repo.2}/refs/heads/main/instll/install.sh?t={time.unix} 302

		# Match /user/repo/script.sh pattern → instll/script.sh (exact match)
		@script_with_sh path_regexp user_repo_script_sh ^/([^/]+)/([^/]+)/(.+)\.sh$
		header @script_with_sh Cache-Control "no-cache, no-store, must-revalidate"
		header @script_with_sh Pragma "no-cache"
		header @script_with_sh Expires "0"
		redir @script_with_sh https://raw.githubusercontent.com/{re.user_repo_script_sh.1}/{re.user_repo_script_sh.2}/refs/heads/main/instll/{re.user_repo_script_sh.3}.sh?t={time.unix} 302

		# Match /user/repo/file pattern → instll/file (no .sh extension, supports subfolders)
		@file_without_sh path_regexp user_repo_file ^/([^/]+)/([^/]+)/(.+)$
		header @file_without_sh Cache-Control "no-cache, no-store, must-revalidate"
		header @file_without_sh Pragma "no-cache"
		header @file_without_sh Expires "0"
		redir @file_without_sh https://raw.githubusercontent.com/{re.user_repo_file.1}/{re.user_repo_file.2}/refs/heads/main/instll/{re.user_repo_file.3}?t={time.unix} 302

		# Default redirect to GitHub repo
		redir https://github.com/rbbr-io/instll.sh 302
	}
}